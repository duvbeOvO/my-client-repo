<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>LOVE Client é›²ç«¯ç®¡ç†å¾Œå°</title>
    <style>
        body { font-family: sans-serif; background: #fdfcfc; display: flex; justify-content: center; padding: 50px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 400px; }
        h2 { color: #ffb6c1; text-align: center; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #ffb6c1; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #ff8c94; }
        #status { font-size: 12px; color: gray; text-align: center; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ’– LOVE Client ç®¡ç†</h2>
        <input type="password" id="token" placeholder="è²¼ä¸Šä½ çš„ GitHub Token (ghp_...)">
        <hr>
        <input type="text" id="playerName" placeholder="ç©å®¶éŠæˆ² ID">
        <input type="text" id="playerColor" placeholder="é¡è‰²ä»£ç¢¼ (ä¾‹å¦‚ d ç‚ºç²‰è‰²)" value="d">
        <input type="text" id="playerPrefix" placeholder="å‰ç¶´åœ–æ¨™ (ä¾‹å¦‚ Â§eâ˜…)">
        <button onclick="updateWhitelist()">âœ¨ åŒæ­¥åˆ°é›²ç«¯</button>
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

    <script>
        async function updateWhitelist() {
            const token = document.getElementById('token').value;
            const name = document.getElementById('playerName').value.trim();
            const color = document.getElementById('playerColor').value.trim();
            const prefix = document.getElementById('playerPrefix').value.trim();
            const status = document.getElementById('status');

            if (!token || !name) return alert("Token å’Œ ID éƒ½è¦å¡«å¯«ï¼");

            status.innerText = "æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...";
            const url = "https://api.github.com/repos/duvbeOvO/my-client-repo/contents/main/config/verified_players.txt";
            const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" };

            try {
                // 1. ç²å–ç›®å‰å…§å®¹
                const res = await fetch(url, { headers });
                const data = await res.json();
                const sha = data.sha;
                let content = decodeURIComponent(escape(atob(data.content))); // è™•ç†ä¸­æ–‡äº‚ç¢¼

                // 2. æª¢æŸ¥é‡è¤‡
                if (content.toLowerCase().includes(name.toLowerCase())) {
                    return alert("è©²ç©å®¶å·²åœ¨åå–®ä¸­ï¼");
                }

                // 3. çµ„åˆæ–°å…§å®¹ (ç©å®¶:é¡è‰²:å‰ç¶´)
                const newEntry = prefix ? `${name}:${color}:${prefix}` : `${name}:${color}`;
                content = content.trim() + "\n" + newEntry;

                // 4. å›å‚³åˆ° GitHub
                status.innerText = "æ­£åœ¨æ¨é€åˆ° GitHub...";
                const putRes = await fetch(url, {
                    method: "PUT",
                    headers,
                    body: JSON.stringify({
                        message: `Web Admin: Add ${name}`,
                        content: btoa(unescape(encodeURIComponent(content))), // è™•ç† UTF-8
                        sha: sha,
                        branch: "main"
                    })
                });

                if (putRes.ok) {
                    alert("âœ… æˆåŠŸï¼ç™½åå–®å·²æ›´æ–°ã€‚");
                    status.innerText = "æ›´æ–°æˆåŠŸï¼";
                } else {
                    alert("âŒ å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ¬Šé™ã€‚");
                }
            } catch (err) {
                alert("é€£ç·šå‡ºéŒ¯: " + err);
            }
        }
    </script>
</body>
</html>
