<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOVE Client | é›²ç«¯å¾Œå°</title>
    <style>
        :root { --main-pink: #ffb6c1; --hover-pink: #ff8c94; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #fff5f7; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 600px; }
        h1 { color: var(--main-pink); text-align: center; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--main-pink); }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--main-pink); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: var(--hover-pink); transform: translateY(-2px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        th { color: #888; font-size: 14px; }
        .del-btn { background: #ff4d4d; padding: 5px 10px; font-size: 12px; width: auto; margin: 0; }
        .status { text-align: center; color: #aaa; font-size: 12px; margin-top: 10px; }
        .tag { padding: 2px 8px; border-radius: 5px; font-size: 12px; background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’– LOVE Client å¾Œå°</h1>
    
    <div class="input-group">
        <input type="password" id="token" placeholder="è¼¸å…¥ GitHub å€‹äººè¨ªå•æ¬Šæ– (Token)">
        <button onclick="loadList()">ğŸ” è®€å–é›²ç«¯åå–®</button>
    </div>

    <hr style="border: 0.5px solid #fcfcfc; margin: 20px 0;">

    <div id="adminPanel" style="display:none;">
        <h3>æ–°å¢ç©å®¶</h3>
        <input type="text" id="newName" placeholder="ç©å®¶ ID">
        <div style="display:flex; gap:10px;">
            <input type="text" id="newColor" placeholder="é¡è‰² (d)" value="d" style="width:30%">
            <input type="text" id="newPrefix" placeholder="å‰ç¶´ (â˜…)" style="width:70%">
        </div>
        <button onclick="addPlayer()">â• æ–°å¢åˆ°ç™½åå–®</button>

        <h3>ç›®å‰åå–®</h3>
        <table id="playerTable">
            <thead>
                <tr>
                    <th>ç©å®¶ ID</th>
                    <th>é¡è‰²/å‰ç¶´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
    <div id="status" class="status">è«‹å…ˆè¼¸å…¥ Token é€²è¡Œé©—è­‰</div>
</div>

<script>
    const config = {
        owner: "duvbeOvO",
        repo: "my-client-repo",
        path: "main/config/verified_players.txt"
    };
    let currentSha = "";
    let playerList = [];

    async function loadList() {
        const token = document.getElementById('token').value;
        const status = document.getElementById('status');
        if(!token) return alert("è«‹è¼¸å…¥ Tokenï¼");

        status.innerText = "è¼‰å…¥ä¸­...";
        const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}`;
        
        try {
            const res = await fetch(url, {
                headers: { "Authorization": `token ${token}` }
            });
            const data = await res.json();
            currentSha = data.sha;
            const content = decodeURIComponent(escape(atob(data.content)));
            
            playerList = content.split('\n').filter(line => line.trim() !== "");
            renderTable();
            
            document.getElementById('adminPanel').style.display = "block";
            status.innerText = "è®€å–æˆåŠŸï¼";
        } catch (err) {
            alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ˜¯å¦æ­£ç¢ºæˆ–è·¯å¾‘æ˜¯å¦å­˜åœ¨ã€‚");
            status.innerText = "é©—è­‰å¤±æ•—";
        }
    }

    function renderTable() {
        const body = document.getElementById('listBody');
        body.innerHTML = "";
        playerList.forEach((line, index) => {
            const parts = line.split(':');
            const name = parts[0];
            const color = parts[1] || "f";
            const prefix = parts[2] || "ç„¡";
            
            body.innerHTML += `
                <tr>
                    <td><b>${name}</b></td>
                    <td><span class="tag">é¡è‰²: ${color}</span> <span class="tag">${prefix}</span></td>
                    <td><button class="del-btn" onclick="deletePlayer(${index})">åˆªé™¤</button></td>
                </tr>
            `;
        });
    }

    async function addPlayer() {
        const name = document.getElementById('newName').value.trim();
        const color = document.getElementById('newColor').value.trim();
        const prefix = document.getElementById('newPrefix').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥ ID");

        const newEntry = prefix ? `${name}:${color}:${prefix}` : `${name}:${color}`;
        playerList.push(newEntry);
        await updateGitHub("æ–°å¢ç©å®¶: " + name);
    }

    async function deletePlayer(index) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä½ç©å®¶å—ï¼Ÿ")) return;
        playerList.splice(index, 1);
        await updateGitHub("åˆªé™¤ç©å®¶");
    }

    async function updateGitHub(msg) {
        const token = document.getElementById('token').value;
        const status = document.getElementById('status');
        const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}`;
        
        status.innerText = "åŒæ­¥åˆ°é›²ç«¯ä¸­...";
        
        const newContent = playerList.join('\n');
        const encodedContent = btoa(unescape(encodeURIComponent(newContent)));

        const res = await fetch(url, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" },
            body: JSON.stringify({
                message: msg,
                content: encodedContent,
                sha: currentSha,
                branch: "main"
            })
        });

        if(res.ok) {
            const data = await res.json();
            currentSha = data.content.sha; // æ›´æ–° SHA æ‰èƒ½é€²è¡Œä¸‹æ¬¡æ“ä½œ
            renderTable();
            status.innerText = "é›²ç«¯åŒæ­¥æˆåŠŸï¼";
            document.getElementById('newName').value = "";
        } else {
            alert("åŒæ­¥å¤±æ•—ï¼");
        }
    }
</script>

</body>
</html>
