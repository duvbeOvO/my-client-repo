<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOVE Client | é›²ç«¯å¾Œå°</title>
    <style>
        :root { --main-pink: #ffb6c1; --hover-pink: #ff8c94; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #fff5f7; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 600px; }
        h1 { color: var(--main-pink); text-align: center; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--main-pink); }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--main-pink); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background: var(--hover-pink); transform: translateY(-2px); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        th { color: #888; font-size: 14px; }
        .del-btn { background: #ff4d4d; padding: 5px 10px; font-size: 12px; width: auto; margin: 0; }
        .status { text-align: center; color: #aaa; font-size: 12px; margin-top: 10px; }
        .tag { padding: 2px 8px; border-radius: 5px; font-size: 12px; background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’– LOVE Client å¾Œå°</h1>
    <div class="input-group">
        <input type="password" id="token" placeholder="åœ¨æ­¤è¼¸å…¥ GitHub Token (åƒ…ç”¨æ–¼ç¶²é æ“ä½œ)">
        <button onclick="loadList()">ğŸ” è®€å–é›²ç«¯åå–®</button>
    </div>

    <div id="adminPanel" style="display:none;">
        <hr style="border: 0.5px solid #eee; margin: 20px 0;">
        <h3>æ–°å¢ç©å®¶</h3>
        <input type="text" id="newName" placeholder="ç©å®¶ ID">
        <div style="display:flex; gap:10px;">
            <input type="text" id="newColor" placeholder="é¡è‰² (d)" value="d" style="width:30%">
            <input type="text" id="newPrefix" placeholder="å‰ç¶´ (â˜…)" style="width:70%">
        </div>
        <button onclick="addPlayer()">â• æ–°å¢åˆ°é›²ç«¯</button>

        <h3>ç›®å‰åå–®</h3>
        <table id="playerTable">
            <thead>
                <tr><th>ç©å®¶ ID</th><th>é¡è‰²/å‰ç¶´</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
    <div id="status" class="status">è«‹è¼¸å…¥ Token ä»¥é€²è¡Œé€£ç·š</div>
</div>

<script>
    const config = {
        owner: "duvbeOvO",
        repo: "my-client-repo",
        path: "main/config/verified_players.txt", // é…åˆä½ çš„ Raw URL è·¯å¾‘
        branch: "main"
    };
    let currentSha = "";
    let playerList = [];

    async function loadList() {
        const token = document.getElementById('token').value.trim();
        const status = document.getElementById('status');
        if(!token) return alert("è«‹è¼¸å…¥ Tokenï¼");

        status.innerText = "æ­£åœ¨é©—è­‰ä¸¦è®€å–...";
        const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}?ref=${config.branch}`;
        
        try {
            const res = await fetch(url, {
                headers: { "Authorization": `token ${token}` }
            });
            const data = await res.json();
            if (data.sha) {
                currentSha = data.sha;
                const content = decodeURIComponent(escape(atob(data.content)));
                playerList = content.split('\n').filter(line => line.trim() !== "");
                renderTable();
                document.getElementById('adminPanel').style.display = "block";
                status.innerText = "è®€å–æˆåŠŸï¼";
            } else { throw new Error(); }
        } catch (err) {
            alert("é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ¬Šé™ï¼");
            status.innerText = "é©—è­‰å¤±æ•—";
        }
    }

    function renderTable() {
        const body = document.getElementById('listBody');
        body.innerHTML = "";
        playerList.forEach((line, index) => {
            const parts = line.split(':');
            body.innerHTML += `
                <tr>
                    <td><b>${parts[0]}</b></td>
                    <td><span class="tag">é¡è‰²: ${parts[1]||'f'}</span> <span class="tag">${parts[2]||'ç„¡'}</span></td>
                    <td><button class="del-btn" onclick="deletePlayer(${index})">åˆªé™¤</button></td>
                </tr>
            `;
        });
    }

    async function addPlayer() {
        const name = document.getElementById('newName').value.trim();
        const color = document.getElementById('newColor').value.trim();
        const prefix = document.getElementById('newPrefix').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥ç©å®¶ ID");
        playerList.push(prefix ? `${name}:${color}:${prefix}` : `${name}:${color}`);
        await updateGitHub("æ–°å¢ç©å®¶: " + name);
    }

    async function deletePlayer(index) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
        playerList.splice(index, 1);
        await updateGitHub("åˆªé™¤ç©å®¶");
    }

    async function updateGitHub(msg) {
        const token = document.getElementById('token').value.trim();
        const status = document.getElementById('status');
        const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}`;
        
        status.innerText = "åŒæ­¥ä¸­...";
        const newContent = playerList.join('\n');
        const encodedContent = btoa(unescape(encodeURIComponent(newContent)));

        const res = await fetch(url, {
            method: "PUT",
            headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json" },
            body: JSON.stringify({ message: msg, content: encodedContent, sha: currentSha, branch: config.branch })
        });

        if(res.ok) {
            const data = await res.json();
            currentSha = data.content.sha;
            renderTable();
            status.innerText = "åŒæ­¥æˆåŠŸï¼";
        } else { alert("åŒæ­¥å¤±æ•—ï¼"); }
    }
</script>
</body>
</html>
